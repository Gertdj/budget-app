{% extends 'finance/base.html' %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Budget Plan - {{ active_date|date:"F Y" }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="?year={{ prev_month_year }}&month={{ prev_month_month }}"
                class="btn btn-sm btn-outline-secondary">Previous</a>
            <button type="button" class="btn btn-sm btn-outline-secondary disabled fw-bold">{{ active_date|date:"F Y"
                }}</button>
            <a href="?year={{ next_month_year }}&month={{ next_month_month }}"
                class="btn btn-sm btn-outline-secondary">Next</a>
        </div>
    </div>
</div>

{% if unpaid_count > 0 %}
<div class="alert alert-warning" role="alert">
    <strong>{{ unpaid_count }}</strong> payment{{ unpaid_count|pluralize }} outstanding.
    <a href="{% url 'outstanding_payments' %}" class="alert-link">View outstanding payments</a>
</div>
{% endif %}

<div class="row">
    <div class="col-md-3">
        <div class="card income-text">
            <div class="card-body">
                <h5 class="text-muted">Total Income</h5>
                <h2>R {{ total_income|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card expense-text">
            <div class="card-body">
                <h5 class="text-muted">Total Expenses</h5>
                <h2>R {{ total_expenses|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-info">
            <div class="card-body">
                <h5 class="text-muted">Total Savings</h5>
                <h2>R {{ total_savings|floatformat:2 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card {% if balance >= 0 %}income-text{% else %}expense-text{% endif %}">
            <div class="card-body">
                <h5 class="text-muted">Balance</h5>
                <h2>R {{ balance|floatformat:2 }}</h2>
                {% if balance < 0 %} <small class="text-danger">⚠️ Over-allocated!</small>
                    {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Income</h5>
            </div>
            <div class="card-body">
                {% if income_budgets %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for budget in income_budgets %}
                        <tr>
                            <td>{{ budget.category.name }}</td>
                            <td class="text-end">R {{ budget.amount|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">No income budgeted for this month. <a href="{% url 'yearly_budget' %}">Set up your
                        budget</a></p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Expenses</h5>
            </div>
            <div class="card-body">
                {% if expense_budgets %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for budget in expense_budgets %}
                        <tr>
                            <td>
                                <a href="{% url 'yearly_budget' %}" class="text-decoration-none text-dark">{{
                                    budget.category.name }}</a>
                            </td>
                            <td class="text-end">R {{ budget.amount|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">No expenses budgeted for this month. <a href="{% url 'yearly_budget' %}">Set up
                        your budget</a></p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Savings & Investments</h5>
            </div>
            <div class="card-body">
                {% if savings_budgets %}
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for budget in savings_budgets %}
                        <tr>
                            <td>
                                <a href="{% url 'yearly_budget' %}" class="text-decoration-none text-dark">{{
                                    budget.category.name }}</a>
                            </td>
                            <td class="text-end">R {{ budget.amount|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">No savings budgeted for this month. <a href="{% url 'yearly_budget' %}">Set up
                        your budget</a></p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <a href="{% url 'yearly_budget' %}" class="btn btn-primary">Edit Budget</a>
        <a href="{% url 'outstanding_payments' %}" class="btn btn-outline-secondary">Outstanding Payments</a>
    </div>
</div>
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                Budget Overview
            </div>
            <div class="card-body">
                <canvas id="overviewChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                Expenses Breakdown
            </div>
            <div class="card-body">
                <canvas id="expensesChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Overview Chart
        const overviewCtx = document.getElementById('overviewChart').getContext('2d');
        new Chart(overviewCtx, {
            type: 'bar',
            data: {
                labels: ['Income', 'Expenses', 'Savings'],
                datasets: [{
                    label: 'Amount (R)',
                    data: [{{ total_income }}, {{ total_expenses }}, {{ total_savings }}],
        backgroundColor: [
        'rgba(25, 135, 84, 0.7)',  // Success/Green
        'rgba(220, 53, 69, 0.7)',  // Danger/Red
        'rgba(13, 202, 240, 0.7)'  // Info/Teal
    ],
        borderColor: [
        'rgba(25, 135, 84, 1)',
        'rgba(220, 53, 69, 1)',
        'rgba(13, 202, 240, 1)'
    ],
        borderWidth: 1
                }]
            },
        options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function (value) {
                        return 'R ' + value;
                    }
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
        });

    // Expenses Breakdown Chart
    const expensesCtx = document.getElementById('expensesChart').getContext('2d');
    const expenseLabels = [{% for item in expense_budgets %}"{{ item.category.name }}"{% if not forloop.last %}, {% endif %} {% endfor %}];
    const expenseData = [{% for item in expense_budgets %}{ { item.amount } } {% if not forloop.last %}, {% endif %} {% endfor %}];

    // Generate random colors for pie chart
    const backgroundColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
        '#E7E9ED', '#71B37C', '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
        '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A',
        '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
        '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC',
        '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
        '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680',
        '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
        '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3',
        '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF'
    ];

    new Chart(expensesCtx, {
        type: 'pie',
        data: {
            labels: expenseLabels,
            datasets: [{
                data: expenseData,
                backgroundColor: backgroundColors.slice(0, expenseLabels.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
    });
</script>
{% endblock %}