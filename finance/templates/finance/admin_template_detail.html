{% extends 'finance/base.html' %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ template.name }}{% if template.is_default %} <span class="badge bg-success">Default</span>{% endif %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'admin_templates' %}" class="btn btn-sm btn-outline-secondary">Back to Templates</a>
        <a href="/admin/finance/budgettemplate/{{ template.id }}/change/" target="_blank" class="btn btn-sm btn-primary ms-2">Edit in Django Admin</a>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5>Description</h5>
                <p class="mb-0">{{ template.description|default:"No description provided." }}</p>
                <hr>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Status:</strong>
                        {% if template.is_active %}
                        <span class="badge bg-success">Active</span>
                        {% else %}
                        <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <strong>Categories:</strong> {{ template.get_category_count }}
                    </div>
                    <div class="col-md-3">
                        <strong>Created By:</strong> {{ template.created_by.email|default:"System" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Created:</strong> {{ template.created_at|date:"Y-m-d H:i" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Template Categories</h5>
            </div>
            <div class="card-body">
                {% if categories_by_type.INCOME or categories_by_type.EXPENSE or categories_by_type.SAVINGS %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th class="text-center">Income</th>
                                <th class="text-center">Expense</th>
                                <th class="text-center">Savings</th>
                                <th class="text-center">Persistent</th>
                                <th class="text-center">Essential</th>
                                <th class="text-center">Payment Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Income Categories -->
                            {% if categories_by_type.INCOME %}
                                {% for group in categories_by_type.INCOME %}
                                <tr>
                                    <td><strong>{{ group.category.name }}</strong></td>
                                    <td class="text-center">✓</td>
                                    <td class="text-center">—</td>
                                    <td class="text-center">—</td>
                                    <td class="text-center">{% if group.category.is_persistent %}✓{% else %}—{% endif %}</td>
                                    <td class="text-center">{% if group.category.is_essential %}✓{% else %}—{% endif %}</td>
                                    <td class="text-center"><small>{{ group.category.get_payment_type_display }}</small></td>
                                </tr>
                                    {% if group.children %}
                                        {% for child in group.children %}
                                        <tr>
                                            <td class="ps-4">↳ {{ child.name }}</td>
                                            <td class="text-center">✓</td>
                                            <td class="text-center">—</td>
                                            <td class="text-center">—</td>
                                            <td class="text-center">{% if child.is_persistent %}✓{% else %}—{% endif %}</td>
                                            <td class="text-center">{% if child.is_essential %}✓{% else %}—{% endif %}</td>
                                            <td class="text-center"><small>{{ child.get_payment_type_display }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            <!-- Expense Categories -->
                            {% if categories_by_type.EXPENSE %}
                                {% for group in categories_by_type.EXPENSE %}
                                <tr>
                                    <td><strong>{{ group.category.name }}</strong></td>
                                    <td class="text-center">—</td>
                                    <td class="text-center">✓</td>
                                    <td class="text-center">—</td>
                                    <td class="text-center">{% if group.category.is_persistent %}✓{% else %}—{% endif %}</td>
                                    <td class="text-center">{% if group.category.is_essential %}✓{% else %}—{% endif %}</td>
                                    <td class="text-center"><small>{{ group.category.get_payment_type_display }}</small></td>
                                </tr>
                                    {% if group.children %}
                                        {% for child in group.children %}
                                        <tr>
                                            <td class="ps-4">↳ {{ child.name }}</td>
                                            <td class="text-center">—</td>
                                            <td class="text-center">✓</td>
                                            <td class="text-center">—</td>
                                            <td class="text-center">{% if child.is_persistent %}✓{% else %}—{% endif %}</td>
                                            <td class="text-center">{% if child.is_essential %}✓{% else %}—{% endif %}</td>
                                            <td class="text-center"><small>{{ child.get_payment_type_display }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            <!-- Savings Categories -->
                            {% if categories_by_type.SAVINGS %}
                                {% for group in categories_by_type.SAVINGS %}
                                <tr>
                                    <td><strong>{{ group.category.name }}</strong></td>
                                    <td class="text-center">—</td>
                                    <td class="text-center">—</td>
                                    <td class="text-center">✓</td>
                                    <td class="text-center">{% if group.category.is_persistent %}✓{% else %}—{% endif %}</td>
                                    <td class="text-center">{% if group.category.is_essential %}✓{% else %}—{% endif %}</td>
                                    <td class="text-center"><small>{{ group.category.get_payment_type_display }}</small></td>
                                </tr>
                                    {% if group.children %}
                                        {% for child in group.children %}
                                        <tr>
                                            <td class="ps-4">↳ {{ child.name }}</td>
                                            <td class="text-center">—</td>
                                            <td class="text-center">—</td>
                                            <td class="text-center">✓</td>
                                            <td class="text-center">{% if child.is_persistent %}✓{% else %}—{% endif %}</td>
                                            <td class="text-center">{% if child.is_essential %}✓{% else %}—{% endif %}</td>
                                            <td class="text-center"><small>{{ child.get_payment_type_display }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No categories in this template yet. <a href="/admin/finance/budgettemplate/{{ template.id }}/change/" target="_blank">Add categories in Django Admin</a>.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="alert alert-info">
            <strong>Note:</strong> To add, edit, or delete categories in this template, use the <strong>"Edit in Django Admin"</strong> button above. 
            The Django Admin interface provides full control over template categories, including inline editing.
        </div>
    </div>
</div>
{% endblock %}

